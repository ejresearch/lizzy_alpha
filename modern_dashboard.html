<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lizzy Alpha - Creative Writing Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <!-- Top Navigation -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo and Main Nav -->
                <div class="flex items-center space-x-8">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-900 dark:text-white">Lizzy Alpha</h1>
                    </div>
                    <nav class="hidden md:flex space-x-6">
                        <a href="#" class="nav-link active" data-section="home">
                            <span class="mr-2">‚åÇ</span>Home
                        </a>
                        <a href="#" class="nav-link" data-section="start">
                            <span class="mr-2">‚ñ∂</span>Start
                        </a>
                        <a href="#" class="nav-link" data-section="intake">
                            <span class="mr-2">üìù</span>Intake
                        </a>
                        <a href="#" class="nav-link" data-section="brainstorm">
                            <span class="mr-2">üí°</span>Brainstorm
                        </a>
                        <a href="#" class="nav-link" data-section="write">
                            <span class="mr-2">‚úç</span>Write
                        </a>
                    </nav>
                </div>

                <!-- Right side controls -->
                <div class="flex items-center space-x-4">
                    <!-- Project Selector -->
                    <select id="projectSelector" class="form-select">
                        <option value="">Select Project...</option>
                        <option value="new">+ Create New Project</option>
                    </select>

                    <!-- Theme Toggle -->
                    <button id="themeToggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <span class="theme-icon">‚òÄ</span>
                    </button>

                    <!-- Menu Button (Mobile) -->
                    <button id="mobileMenuButton" class="md:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <span class="text-lg">‚ò∞</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobileMenu" class="hidden md:hidden bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
            <div class="px-4 py-2 space-y-1">
                <a href="#" class="mobile-nav-link" data-section="home">‚åÇ Home</a>
                <a href="#" class="mobile-nav-link" data-section="start">‚ñ∂ Start</a>
                <a href="#" class="mobile-nav-link" data-section="intake">üìù Intake</a>
                <a href="#" class="mobile-nav-link" data-section="brainstorm">üí° Brainstorm</a>
                <a href="#" class="mobile-nav-link" data-section="write">‚úç Write</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Home Section -->
        <div id="homeSection" class="section active">
            <!-- Project Overview Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Start Card -->
                <div class="workflow-card group" data-section="start">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-blue-100 dark:bg-blue-900 rounded-lg">
                            <span class="text-2xl text-blue-600 dark:text-blue-400">‚ñ∂</span>
                        </div>
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Step 1</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Start</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Initialize new creative projects with genre and tone settings</p>
                    <button class="btn-primary w-full">Create Project</button>
                </div>

                <!-- Intake Card -->
                <div class="workflow-card group" data-section="intake">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-green-100 dark:bg-green-900 rounded-lg">
                            <span class="text-2xl text-green-600 dark:text-green-400">üìù</span>
                        </div>
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Step 2</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Intake</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Define characters, scenes, and story elements</p>
                    <button class="btn-secondary w-full">Add Content</button>
                </div>

                <!-- Brainstorm Card -->
                <div class="workflow-card group" data-section="brainstorm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-purple-100 dark:bg-purple-900 rounded-lg">
                            <span class="text-2xl text-purple-600 dark:text-purple-400">üí°</span>
                        </div>
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Step 3</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Brainstorm</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Generate AI-powered creative ideas with LightRAG</p>
                    <button class="btn-secondary w-full">Generate Ideas</button>
                </div>

                <!-- Write Card -->
                <div class="workflow-card group" data-section="write">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-orange-100 dark:bg-orange-900 rounded-lg">
                            <span class="text-2xl text-orange-600 dark:text-orange-400">‚úç</span>
                        </div>
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Step 4</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Write</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Create and refine scene drafts and content</p>
                    <button class="btn-secondary w-full">Start Writing</button>
                </div>
            </div>

            <!-- Recent Projects Table -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Recent Projects</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="table-header">Project Name</th>
                                <th class="table-header">Genre</th>
                                <th class="table-header">Status</th>
                                <th class="table-header">Last Modified</th>
                                <th class="table-header">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="projectTableBody" class="divide-y divide-gray-200 dark:divide-gray-600">
                            <!-- Projects will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Start Section -->
        <div id="startSection" class="section">
            <div class="max-w-2xl">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Create New Project</h2>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <form id="newProjectForm" class="space-y-6">
                        <div>
                            <label class="form-label">Project Name</label>
                            <input type="text" id="projectName" class="form-input" placeholder="Enter project name..." required>
                        </div>
                        <div>
                            <label class="form-label">Title</label>
                            <input type="text" id="projectTitle" class="form-input" placeholder="Story title...">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Genre</label>
                                <select id="projectGenre" class="form-select">
                                    <option value="Romance">Romance</option>
                                    <option value="Drama">Drama</option>
                                    <option value="Comedy">Comedy</option>
                                    <option value="Thriller">Thriller</option>
                                    <option value="Fantasy">Fantasy</option>
                                    <option value="Sci-Fi">Sci-Fi</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Tone</label>
                                <select id="projectTone" class="form-select">
                                    <option value="Romantic Comedy">Romantic Comedy</option>
                                    <option value="Dramatic Romance">Dramatic Romance</option>
                                    <option value="Light Comedy">Light Comedy</option>
                                    <option value="Dark Drama">Dark Drama</option>
                                    <option value="Adventure">Adventure</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" class="btn-primary">Create Project</button>
                            <button type="button" class="btn-secondary" onclick="showSection('home')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Intake Section -->
        <div id="intakeSection" class="section">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Content Intake</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Characters -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Characters</h3>
                    <button class="btn-primary mb-4" onclick="openModal('characterModal')">Add Character</button>
                    <div id="charactersList" class="space-y-3">
                        <!-- Characters will be populated here -->
                    </div>
                </div>

                <!-- Scenes -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Scenes</h3>
                    <button class="btn-primary mb-4" onclick="openModal('sceneModal')">Add Scene</button>
                    <div id="scenesList" class="space-y-3">
                        <!-- Scenes will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Brainstorm Section -->
        <div id="brainstormSection" class="section">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">AI Brainstorming</h2>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <form id="brainstormForm" class="space-y-4">
                    <div>
                        <label class="form-label">Brainstorm Query</label>
                        <textarea id="brainstormQuery" class="form-input" rows="3" placeholder="What would you like to brainstorm about?"></textarea>
                    </div>
                    <button type="submit" class="btn-primary">Generate Ideas</button>
                </form>
                <div id="brainstormResults" class="mt-6">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>

        <!-- Write Section -->
        <div id="writeSection" class="section">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Scene Writing</h2>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <form id="writeForm" class="space-y-4">
                    <div>
                        <label class="form-label">Select Scene</label>
                        <select id="sceneSelector" class="form-select">
                            <option value="">Choose a scene to write...</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">Generate Scene</button>
                </form>
                <div id="writeResults" class="mt-6">
                    <!-- Generated content will be populated here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Character Modal -->
    <div id="characterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Add Character</h3>
                <button class="modal-close" onclick="closeModal('characterModal')">√ó</button>
            </div>
            <form id="characterForm" class="space-y-4">
                <div>
                    <label class="form-label">Character Name</label>
                    <input type="text" id="characterName" class="form-input" required>
                </div>
                <div>
                    <label class="form-label">Role</label>
                    <select id="characterRole" class="form-select">
                        <option value="Protagonist">Protagonist</option>
                        <option value="Love Interest">Love Interest</option>
                        <option value="Supporting">Supporting</option>
                        <option value="Antagonist">Antagonist</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Description</label>
                    <textarea id="characterDescription" class="form-input" rows="3"></textarea>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="btn-primary">Add Character</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('characterModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scene Modal -->
    <div id="sceneModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Add Scene</h3>
                <button class="modal-close" onclick="closeModal('sceneModal')">√ó</button>
            </div>
            <form id="sceneForm" class="space-y-4">
                <div>
                    <label class="form-label">Scene Title</label>
                    <input type="text" id="sceneTitle" class="form-input" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Act</label>
                        <input type="number" id="sceneAct" class="form-input" min="1" value="1">
                    </div>
                    <div>
                        <label class="form-label">Scene</label>
                        <input type="number" id="sceneNumber" class="form-input" min="1" value="1">
                    </div>
                </div>
                <div>
                    <label class="form-label">Description</label>
                    <textarea id="sceneDescription" class="form-input" rows="3"></textarea>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="btn-primary">Add Scene</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('sceneModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        /* Custom Styles */
        .nav-link {
            @apply px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200;
        }
        
        .nav-link.active {
            @apply text-primary-600 dark:text-primary-400 bg-primary-50 dark:bg-primary-900;
        }
        
        .mobile-nav-link {
            @apply block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700;
        }
        
        .workflow-card {
            @apply bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md transition-all duration-200 cursor-pointer;
        }
        
        .workflow-card:hover {
            @apply transform -translate-y-1;
        }
        
        .btn-primary {
            @apply bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200;
        }
        
        .btn-secondary {
            @apply bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-900 dark:text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200;
        }
        
        .form-input {
            @apply w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent;
        }
        
        .form-select {
            @apply w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent;
        }
        
        .form-label {
            @apply block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2;
        }
        
        .table-header {
            @apply px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider;
        }
        
        .section {
            @apply hidden;
        }
        
        .section.active {
            @apply block;
        }
        
        .modal {
            @apply fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50;
        }
        
        .modal.active {
            @apply flex;
        }
        
        .modal-content {
            @apply bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 max-h-96 overflow-y-auto;
        }
        
        .modal-header {
            @apply flex justify-between items-center mb-4;
        }
        
        .modal-close {
            @apply text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl font-bold;
        }
    </style>

    <script>
        // Application State
        let currentProject = null;
        let projects = [];
        let characters = [];
        let scenes = [];

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            loadProjects();
            setupEventListeners();
            populateProjectTable();
            loadTonePresets();
            loadWritingStyles();
        });

        // Theme Management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.classList.toggle('dark', savedTheme === 'dark');
            updateThemeIcon();
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const icon = document.querySelector('.theme-icon');
            const isDark = document.documentElement.classList.contains('dark');
            icon.textContent = isDark ? '‚òÄ' : '‚òΩ';
        }

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show target section
            document.getElementById(sectionName + 'Section').classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
        }

        // Modal Management
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Project Management
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const data = await response.json();
                
                if (data.status === 'success') {
                    projects = data.projects;
                } else {
                    console.error('Error loading projects:', data.message);
                    // Fallback to sample data
                    projects = [
                        {
                            name: "Elle",
                            title: "Elle's Story",
                            genre: "Romance",
                            tone: "Romantic Comedy",
                            status: "In Progress",
                            last_modified: "2025-01-20"
                        }
                    ];
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                // Fallback to sample data
                projects = [
                    {
                        name: "Elle",
                        title: "Elle's Story", 
                        genre: "Romance",
                        tone: "Romantic Comedy",
                        status: "In Progress",
                        last_modified: "2025-01-20"
                    }
                ];
            }
            
            updateProjectSelector();
        }

        function updateProjectSelector() {
            const selector = document.getElementById('projectSelector');
            selector.innerHTML = '<option value="">Select Project...</option><option value="new">+ Create New Project</option>';
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.name;
                option.textContent = project.title || project.name;
                selector.appendChild(option);
            });
        }

        function populateProjectTable() {
            const tbody = document.getElementById('projectTableBody');
            tbody.innerHTML = '';
            
            projects.forEach(project => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                        ${project.title || project.name}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        ${project.genre}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                            ${project.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        ${project.last_modified}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                        <button onclick="selectProject('${project.name}')" class="text-primary-600 hover:text-primary-900">Open</button>
                        <button onclick="editProject('${project.name}')" class="text-gray-600 hover:text-gray-900">Edit</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function selectProject(projectName) {
            currentProject = projects.find(p => p.name === projectName);
            document.getElementById('projectSelector').value = projectName;
            
            if (currentProject) {
                try {
                    const response = await fetch(`/api/projects/${projectName}`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        characters = data.characters || [];
                        scenes = data.scenes || [];
                    } else {
                        characters = [];
                        scenes = [];
                    }
                } catch (error) {
                    console.error('Error loading project details:', error);
                    characters = [];
                    scenes = [];
                }
                
                updateCharactersList();
                updateScenesList();
                updateSceneSelector();
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Mobile menu
            document.getElementById('mobileMenuButton').addEventListener('click', function() {
                document.getElementById('mobileMenu').classList.toggle('hidden');
            });
            
            // Navigation
            document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection(this.dataset.section);
                });
            });
            
            // Workflow cards
            document.querySelectorAll('.workflow-card').forEach(card => {
                card.addEventListener('click', function() {
                    showSection(this.dataset.section);
                });
            });
            
            // Project selector
            document.getElementById('projectSelector').addEventListener('change', function() {
                if (this.value === 'new') {
                    showSection('start');
                } else if (this.value) {
                    selectProject(this.value);
                }
            });
            
            // Forms
            document.getElementById('newProjectForm').addEventListener('submit', handleNewProject);
            document.getElementById('characterForm').addEventListener('submit', handleAddCharacter);
            document.getElementById('sceneForm').addEventListener('submit', handleAddScene);
            document.getElementById('brainstormForm').addEventListener('submit', handleBrainstorm);
            document.getElementById('writeForm').addEventListener('submit', handleWrite);
        }

        // Form Handlers
        async function handleNewProject(e) {
            e.preventDefault();
            
            const formData = {
                projectName: document.getElementById('projectName').value,
                title: document.getElementById('projectTitle').value,
                genre: document.getElementById('projectGenre').value,
                tone: document.getElementById('projectTone').value
            };
            
            try {
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Reload projects from server
                    await loadProjects();
                    populateProjectTable();
                    selectProject(formData.projectName);
                    showSection('home');
                    document.getElementById('newProjectForm').reset();
                    
                    alert(`Project "${formData.title || formData.projectName}" created successfully!`);
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                console.error('Error creating project:', error);
                alert('Error creating project. Please check your connection and try again.');
            }
        }

        async function handleAddCharacter(e) {
            e.preventDefault();
            
            if (!currentProject) {
                alert('Please select a project first.');
                return;
            }
            
            const character = {
                name: document.getElementById('characterName').value,
                role: document.getElementById('characterRole').value,
                description: document.getElementById('characterDescription').value
            };
            
            try {
                const response = await fetch(`/api/projects/${currentProject.name}/characters`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(character)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    characters.push(character);
                    updateCharactersList();
                    closeModal('characterModal');
                    document.getElementById('characterForm').reset();
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                console.error('Error adding character:', error);
                alert('Error adding character. Please try again.');
            }
        }

        function handleAddScene(e) {
            e.preventDefault();
            
            const scene = {
                title: document.getElementById('sceneTitle').value,
                act: parseInt(document.getElementById('sceneAct').value),
                scene: parseInt(document.getElementById('sceneNumber').value),
                description: document.getElementById('sceneDescription').value
            };
            
            scenes.push(scene);
            updateScenesList();
            updateSceneSelector();
            closeModal('sceneModal');
            document.getElementById('sceneForm').reset();
        }

        async function handleBrainstorm(e) {
            e.preventDefault();
            
            const query = document.getElementById('brainstormQuery').value;
            
            if (!currentProject) {
                alert('Please select a project first.');
                return;
            }
            
            if (!query.trim()) {
                alert('Please enter a brainstorming query.');
                return;
            }
            
            const resultsDiv = document.getElementById('brainstormResults');
            resultsDiv.innerHTML = '<div class="text-center py-4">üß† Generating creative ideas...</div>';
            
            try {
                const response = await fetch(`/api/projects/${currentProject.name}/brainstorm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query: query,
                        tone: currentProject.tone 
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    resultsDiv.innerHTML = `
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-semibold text-gray-900 dark:text-white">Generated Ideas</h4>
                                <span class="text-xs text-gray-500 dark:text-gray-400">${result.session_name}</span>
                            </div>
                            <div class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                                ${result.ideas.map(idea => `<p class="flex items-start"><span class="mr-2 text-primary-500">‚Ä¢</span><span>${idea}</span></p>`).join('')}
                            </div>
                            <div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-600">
                                <p class="text-xs text-gray-500 dark:text-gray-400">üíæ Session saved to project brainstorming history</p>
                            </div>
                        </div>
                    `;
                    
                    // Clear the query for next use
                    document.getElementById('brainstormQuery').value = '';
                } else {
                    resultsDiv.innerHTML = `<div class="text-red-600 bg-red-50 p-3 rounded">Error: ${result.message}</div>`;
                }
            } catch (error) {
                console.error('Error brainstorming:', error);
                resultsDiv.innerHTML = '<div class="text-red-600 bg-red-50 p-3 rounded">Network error. Please check your connection and try again.</div>';
            }
        }

        async function handleWrite(e) {
            e.preventDefault();
            
            const sceneId = document.getElementById('sceneSelector').value;
            
            if (!sceneId) {
                alert('Please select a scene to write.');
                return;
            }
            
            if (!currentProject) {
                alert('Please select a project first.');
                return;
            }
            
            const resultsDiv = document.getElementById('writeResults');
            resultsDiv.innerHTML = '<div class="text-center py-4">‚úçÔ∏è Generating scene content...</div>';
            
            try {
                // Get the selected scene data
                const selectedScene = scenes[parseInt(sceneId)];
                
                if (!selectedScene) {
                    throw new Error('Selected scene not found');
                }
                
                const response = await fetch(`/api/projects/${currentProject.name}/write`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        scene_data: {
                            title: selectedScene.title,
                            act: selectedScene.act,
                            scene: selectedScene.scene,
                            purpose: selectedScene.purpose || 'scene development',
                            characters_present: selectedScene.characters_present || 'main characters',
                            key_events: selectedScene.key_events || 'scene progression'
                        },
                        writing_style: {
                            name: 'Detailed Narrative',
                            approach: 'comprehensive storytelling with character development'
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    resultsDiv.innerHTML = `
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-semibold text-gray-900 dark:text-white">Generated Scene Content</h4>
                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                    ${result.word_count} words ‚Ä¢ ${result.writing_style}
                                </div>
                            </div>
                            <div class="prose dark:prose-invert text-sm max-w-none">
                                <pre class="whitespace-pre-wrap font-sans">${result.content}</pre>
                            </div>
                            <div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-600 flex justify-between items-center">
                                <p class="text-xs text-gray-500 dark:text-gray-400">üíæ Draft saved (ID: ${result.draft_id})</p>
                                <button onclick="exportDraft(${result.draft_id})" class="text-xs bg-primary-600 text-white px-2 py-1 rounded hover:bg-primary-700">
                                    Download Draft
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `<div class="text-red-600 bg-red-50 p-3 rounded">Error: ${result.message}</div>`;
                }
            } catch (error) {
                console.error('Error generating scene:', error);
                resultsDiv.innerHTML = '<div class="text-red-600 bg-red-50 p-3 rounded">Error generating scene. Please try again.</div>';
            }
        }

        // Update UI Functions
        function updateCharactersList() {
            const container = document.getElementById('charactersList');
            container.innerHTML = '';
            
            characters.forEach((character, index) => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-gray-50 dark:bg-gray-700 rounded border';
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium text-gray-900 dark:text-white">${character.name}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">${character.role}</div>
                        </div>
                        <button onclick="removeCharacter(${index})" class="text-red-600 hover:text-red-800 text-sm">Remove</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateScenesList() {
            const container = document.getElementById('scenesList');
            container.innerHTML = '';
            
            scenes.forEach((scene, index) => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-gray-50 dark:bg-gray-700 rounded border';
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium text-gray-900 dark:text-white">${scene.title}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Act ${scene.act}, Scene ${scene.scene}</div>
                        </div>
                        <button onclick="removeScene(${index})" class="text-red-600 hover:text-red-800 text-sm">Remove</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateSceneSelector() {
            const selector = document.getElementById('sceneSelector');
            selector.innerHTML = '<option value="">Choose a scene to write...</option>';
            
            scenes.forEach((scene, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${scene.title} (Act ${scene.act}, Scene ${scene.scene})`;
                selector.appendChild(option);
            });
        }

        function removeCharacter(index) {
            characters.splice(index, 1);
            updateCharactersList();
        }

        function removeScene(index) {
            scenes.splice(index, 1);
            updateScenesList();
            updateSceneSelector();
        }

        function editProject(projectName) {
            const project = projects.find(p => p.name === projectName);
            if (project) {
                // Populate form with project data
                document.getElementById('projectName').value = project.name;
                document.getElementById('projectTitle').value = project.title || '';
                document.getElementById('projectGenre').value = project.genre;
                document.getElementById('projectTone').value = project.tone;
                showSection('start');
            }
        }

        // Export draft function
        async function exportDraft(draftId) {
            if (!currentProject) {
                alert('No project selected');
                return;
            }
            
            try {
                const response = await fetch(`/api/projects/${currentProject.name}/drafts/${draftId}/export`);
                
                if (response.ok) {
                    // Create download link
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // Get filename from response headers
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = `draft_${draftId}.txt`;
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                        if (filenameMatch) {
                            filename = filenameMatch[1];
                        }
                    }
                    
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Error downloading draft');
                }
            } catch (error) {
                console.error('Error exporting draft:', error);
                alert('Error downloading draft');
            }
        }

        // Load tone presets and writing styles
        async function loadTonePresets() {
            try {
                const response = await fetch('/api/tone-presets');
                const data = await response.json();
                
                if (data.status === 'success') {
                    window.tonePresets = data.tone_presets;
                }
            } catch (error) {
                console.error('Error loading tone presets:', error);
            }
        }

        async function loadWritingStyles() {
            try {
                const response = await fetch('/api/writing-styles');
                const data = await response.json();
                
                if (data.status === 'success') {
                    window.writingStyles = data.writing_styles;
                }
            } catch (error) {
                console.error('Error loading writing styles:', error);
            }
        }
    </script>
</body>
</html>